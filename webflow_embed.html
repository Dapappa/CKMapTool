<!-- Google Font -->
<link
  href="https://fonts.googleapis.com/css2?family=Bangers&display=swap"
  rel="stylesheet"
/>

<!-- External CSS (via jsDelivr) -->
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/gh/Dapappa/CKMapTool/styles.css"
/>

<!-- Adding inline styles to ensure visibility -->
<style>
  .zone-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }

  .zone-modal.active {
    display: flex !important;
  }

  .modal-content {
    background-color: #fff;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
  }

  .modal-header {
    padding: 15px;
    border-bottom: 1px solid #eee;
    position: relative;
  }

  .modal-title {
    margin: 0;
    font-size: 1.5rem;
    text-align: center;
  }

  .close-button {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 28px;
    font-weight: bold;
    background: transparent;
    border: none;
    cursor: pointer;
  }

  .image-slider {
    position: relative;
    padding: 15px;
  }

  .image-slider img {
    max-width: 100%;
    max-height: 60vh;
    display: block;
    margin: 0 auto;
    cursor: pointer;
    transition: transform 0.3s ease;
    border-radius: 4px;
  }

  .image-slider img:hover {
    transform: scale(1.02);
  }

  .slider-container {
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    min-height: 200px;
    margin-bottom: 10px;
    background-color: #f8f8f8;
    border-radius: 4px;
    padding: 10px;
  }

  .prev-button,
  .next-button {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    font-size: 20px;
    line-height: 1;
    cursor: pointer;
    z-index: 2;
    transition: background-color 0.3s;
  }

  .prev-button:hover,
  .next-button:hover {
    background-color: rgba(0, 0, 0, 0.8);
  }

  .prev-button {
    left: 10px;
  }

  .next-button {
    right: 10px;
  }

  /* Initial overlay styling */
  .initial-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: rgba(0, 0, 0, 0.4);
    opacity: 0;
    transition: opacity 0.5s ease, visibility 0s linear 0.5s;
    z-index: 10;
    visibility: visible;
  }

  .initial-overlay.fade-out {
    opacity: 0;
    visibility: hidden;
  }

  .instruction-text {
    color: white;
    font-size: 24px;
    text-align: center;
    padding: 15px 25px;
    background-color: rgba(0, 0, 0, 0.6);
    border-radius: 8px;
    max-width: 80%;
    font-weight: bold;
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
  }

  /* Fullscreen view styling */
  .fullscreen-view {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    z-index: 2000;
    justify-content: center;
    align-items: center;
  }

  .fullscreen-view.active {
    display: flex !important;
  }

  .fullscreen-image-container {
    position: relative;
    width: 90%;
    height: 90%;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .fullscreen-image-container img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    border-radius: 4px;
  }

  .close-fullscreen {
    position: absolute;
    top: 20px;
    right: 20px;
    font-size: 36px;
    color: white;
    background: transparent;
    border: none;
    cursor: pointer;
    z-index: 2001;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: rgba(0, 0, 0, 0.5);
    transition: background-color 0.3s;
  }

  .close-fullscreen:hover {
    background-color: rgba(0, 0, 0, 0.8);
  }

  /* SVG Highlight Styles - Added for cross-browser compatibility */
  .zone-highlight {
    position: absolute;
    pointer-events: none;
    z-index: 1;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .highlights-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 3;
  }

  .zone-highlight.active {
    opacity: 0.6;
    fill: rgba(255, 0, 0, 0.2); /* Red fill with transparency */
    stroke: #ff0000;
    stroke-width: 3px;
  }

  /* Explicitly style the polygon element */
  polygon.zone-highlight {
    fill-opacity: 0;
    stroke-opacity: 0;
  }

  polygon.zone-highlight.active {
    fill-opacity: 0.6;
    stroke-opacity: 1;
  }

  .zone-highlight polygon {
    stroke-width: 3px;
  }

  /* Zone label styling */
  .zone-label {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-family: "Komikatitle Axis", "Bangers", "Impact", sans-serif;
    font-size: 3rem;
    font-weight: 900;
    color: #ff0000;
    text-shadow: 0 0 10px rgba(0, 0, 0, 0.7), 0 0 5px rgba(0, 0, 0, 0.5);
    text-align: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 2;
    pointer-events: none;
    width: 80%;
  }

  .zone-label.active {
    opacity: 1;
  }

  /* Responsive styles */
  @media (max-width: 768px) {
    .instruction-text {
      font-size: 18px;
      padding: 12px 20px;
    }

    .modal-title {
      font-size: 1.2rem;
    }

    .prev-button,
    .next-button {
      width: 32px;
      height: 32px;
      font-size: 16px;
    }

    .close-fullscreen {
      top: 15px;
      right: 15px;
      font-size: 28px;
      width: 40px;
      height: 40px;
    }
  }

  @media (max-width: 480px) {
    .instruction-text {
      font-size: 16px;
      padding: 10px 15px;
    }

    .slider-container {
      min-height: 150px;
    }
  }

  /* Mobile glass rectangles */
  .mobile-zones-container {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    padding: 20px;
    box-sizing: border-box;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
    background-color: rgba(
      245,
      245,
      245,
      0.7
    ); /* More opaque to ensure buttons are visible over the map */
    z-index: 5;
  }

  .mobile-zone-button {
    width: 85%;
    height: 16%;
    margin: 2% 0;
    background: rgba(255, 255, 255, 0.5); /* More opaque background */
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.5);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); /* Stronger shadow for visibility */
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: "Komikatitle Axis", "Bangers", "Impact", sans-serif;
    font-size: 2rem;
    font-weight: bold;
    color: #333;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    position: relative;
    overflow: hidden;
  }
</style>

<div class="map-container">
  <!-- The main map with image map areas -->
  <div class="map-wrapper">
    <!-- Note the URL-encoded space: City%20Map.svg -->
    <img
      src="https://cdn.jsdelivr.net/gh/Dapappa/CKMapTool/City%20Map.svg"
      usemap="#image-map"
      class="main-map"
    />
    <div class="zone-label"></div>
    <div class="highlights-container"></div>

    <!-- Initial overlay with tap instructions -->
    <div class="initial-overlay">
      <div class="instruction-text">Tap a region to explore</div>
    </div>
  </div>

  <map name="image-map">
    <area
      target="_self"
      alt="NorthWestAreaA"
      title="NorthWestAreaA"
      href="#"
      coords="116,639,284,638,287,558,296,552,295,543,287,533,284,500,291,497,274,485,322,476,373,475,369,408,289,357,277,382,221,410,243,425,225,441,203,445,187,456,137,451,125,456"
      shape="poly"
    />
    <area
      target="_self"
      alt="NorthWestAreaB"
      title="NorthWestAreaB"
      href="#"
      coords="73,226,71,353,126,357,115,405,210,439,232,423,217,408,264,383,284,357,298,337,299,304,317,284,322,275,319,258,299,248,289,236,283,228,229,225,133,222"
      shape="poly"
    />
    <area
      target="_self"
      alt="NorthWestAreaC"
      title="NorthWestAreaC"
      href="#"
      coords="227,142,225,174,243,182,248,205,246,218,285,224,296,234,301,242,310,249,319,254,322,269,321,282,330,292,338,292,345,290,354,294,371,312,385,330,393,351,406,346,420,349,446,348,456,344,457,320,455,303,418,274,419,260,428,248,432,234,419,221,417,208,417,196,421,179,424,169,439,163,449,159,457,154,456,126,454,99,379,99,378,137"
      shape="poly"
    />
    <area
      target="_self"
      alt="NorthEastAreaC"
      title="NorthEastAreaC"
      href="#"
      coords="425,171,480,161,485,140,601,141,605,163,651,166,644,190,647,215,519,221,458,301,420,272,428,256,434,239,427,220,419,215"
      shape="poly"
    />
    <area
      target="_self"
      alt="NorthEastAreaB"
      title="NorthEastAreaB"
      href="#"
      coords="522,229,648,229,649,263,676,271,692,282,699,353,700,387,697,416,694,441,695,475,504,472,500,449,492,436,487,428,480,417,478,394,468,370,469,297,474,280,512,235,517,233"
      shape="poly"
    />
    <area
      target="_self"
      alt="NorthEastAreaA"
      title="NorthEastAreaA"
      href="#"
      coords="503,481,692,482,691,530,701,533,700,544,691,557,676,559,652,561,650,574,630,580,607,583,572,585,529,574"
      shape="poly"
    />
    <area
      target="_self"
      alt="SouthEastAreaA"
      title="SouthEastAreaA"
      href="#"
      coords="542,582,541,589,532,597,529,612,529,631,523,642,504,661,502,677,510,698,494,702,483,722,488,760,500,788,519,799,539,804,546,791,556,725,583,721,644,716,673,722,688,718,694,718,693,643,629,638,628,596,616,588"
      shape="poly"
    />
    <area
      target="_self"
      alt="SouthEastAreaB"
      title="SouthEastAreaB"
      href="#"
      coords="602,1085,619,1046,643,1037,662,1018,719,995,721,939,700,874,694,745,669,752,643,772,625,771,623,735,560,733,550,796,545,812,527,814,537,844,559,847,569,858,569,875,574,886,566,910,561,926,557,933,554,947,556,976,563,1002,562,1020,570,1043,592,1080,595,1084"
      shape="poly"
    />
    <area
      target="_self"
      alt="SouthWestAreaB"
      title="SouthWestAreaB"
      href="#"
      coords="371,866,446,897,495,941,510,968,545,999,547,1016,509,1021,512,1033,526,1043,548,1061,578,1063,601,1091,594,1101,515,1099,464,1033,437,1032,423,1021,383,1017,375,987,335,976,317,960,310,940,308,920,305,896,302,884,335,887,348,894"
      shape="poly"
    />
    <area
      target="_self"
      alt="SouthWestAreaA"
      title="SouthWestAreaA"
      href="#"
      coords="291,850,309,858,328,854,335,858,350,845,358,846,383,840,399,846,410,855,424,860,461,866,494,905,513,914,532,904,553,897,532,865,533,846,521,834,519,813,499,798,484,763,466,740,457,726,418,729,414,691,368,691,375,727,374,748,360,746,347,744,334,745,321,745,308,740,291,735"
      shape="poly"
    />
    <area
      target="_self"
      alt="DowntownAreaB"
      title="DowntownAreaB"
      href="#"
      coords="284,489,298,500,293,519,299,544,297,565,291,599,321,588,345,564,524,567,497,479,496,458,477,426,473,390,458,356,411,353,396,360,378,385,377,405,380,418,378,445,379,459,382,474,328,479,303,482"
      shape="poly"
    />
    <area
      target="_self"
      alt="DowntownAreaA"
      title="DowntownAreaA"
      href="#"
      coords="420,675,420,723,454,721,470,736,492,698,501,695,495,677,497,662,502,655,515,645,521,633,524,622,526,608,526,595,537,587,526,580,519,573,345,568,324,591,288,604,289,631,291,643,290,671,297,690,328,691,325,666,342,665,351,654,352,644,372,639,385,642,392,652,372,652,380,665,376,676,381,682,411,683"
      shape="poly"
    />
  </map>
</div>

<!-- The zone modal for displaying images -->
<div class="zone-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title"></h2>
      <button class="close-button">&times;</button>
    </div>
    <div class="modal-body">
      <div class="image-slider">
        <div class="slider-container">
          <!-- Images will be loaded here dynamically -->
        </div>
        <button class="prev-button">&larr;</button>
        <button class="next-button">&rarr;</button>
      </div>
    </div>
  </div>
</div>

<!-- Full screen image view -->
<div class="fullscreen-view">
  <button class="close-fullscreen">&times;</button>
  <div class="fullscreen-image-container">
    <!-- Fullscreen image will be loaded here -->
  </div>
</div>

<!-- External JS (via jsDelivr) -->
<script
  src="https://cdn.jsdelivr.net/gh/Dapappa/CKMapTool/script.js"
  defer
></script>

<!-- Fallback script to ensure functionality -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Make sure zone modal can be activated
    const areas = document.querySelectorAll("area");
    const zoneModal = document.querySelector(".zone-modal");
    const closeButton = document.querySelector(".close-button");
    const mapImage = document.querySelector(".main-map");
    const mapWrapper = document.querySelector(".map-wrapper");
    const initialOverlay = document.querySelector(".initial-overlay");
    const fullscreenView = document.querySelector(".fullscreen-view");
    const closeFullscreenButton = document.querySelector(".close-fullscreen");
    const zoneLabel = document.querySelector(".zone-label");
    const highlightsContainer = document.querySelector(".highlights-container");

    // Flag to track if we're on mobile
    const isMobile = window.innerWidth <= 768;

    // Enable debug mode via URL parameter
    const debugMode = window.location.search.includes("debug=true");
    if (debugMode) {
      console.log("Debug mode enabled - logging highlight details");
    }

    // Store all zones with their data
    const allZones = [];

    // Define image paths with exact filenames from the repository
    const zoneImageMap = {
      NorthWestAreaA: [
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67ce152ca79e102efac06d9c_Northwest%20Calgary%20Distribution%20Map%20(3)-1.png",
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67ce152cf32904d35d17f639_Northwest%20Calgary%20Distribution%20Map%20(3)-2.png",
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67ce152d08ea1ae1f650e810_Northwest%20Calgary%20Distribution%20Map%20(3)-3.png",
      ],
      NorthWestAreaB: [
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67ce152ca79e102efac06d9c_Northwest%20Calgary%20Distribution%20Map%20(3)-1.png",
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67ce152cf32904d35d17f639_Northwest%20Calgary%20Distribution%20Map%20(3)-2.png",
      ],
      NorthWestAreaC: [
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67ce152ca79e102efac06d9c_Northwest%20Calgary%20Distribution%20Map%20(3)-1.png",
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67ce152cf32904d35d17f639_Northwest%20Calgary%20Distribution%20Map%20(3)-2.png",
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67ce152d08ea1ae1f650e810_Northwest%20Calgary%20Distribution%20Map%20(3)-3.png",
      ],
      NorthEastAreaA: [
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67ce152c2d59410587b5d1bf_North%20East-1.png",
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67ce152ce965c5b385b91dbc_North%20East-2.png",
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67ce152d32c401d798b756d5_North%20East-3.png",
      ],
      NorthEastAreaB: [
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67ce152c2d59410587b5d1bf_North%20East-1.png",
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67ce152ce965c5b385b91dbc_North%20East-2.png",
      ],
      NorthEastAreaC: [
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67ce152c2d59410587b5d1bf_North%20East-1.png",
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67ce152ce965c5b385b91dbc_North%20East-2.png",
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67ce152d32c401d798b756d5_North%20East-3.png",
      ],
      DowntownAreaA: [
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67ce1656df0450fd7aa4d763_Downtown%20Calgary%20Map%20(1)-1.png",
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67ce16564099212dfea6b2b2_Downtown%20Calgary%20Map%20(1)-2.png",
      ],
      DowntownAreaB: [
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67ce1656df0450fd7aa4d763_Downtown%20Calgary%20Map%20(1)-1.png",
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67ce16564099212dfea6b2b2_Downtown%20Calgary%20Map%20(1)-2.png",
      ],
      SouthEastAreaA: [
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67c1d2b874833dd5316b3ca8_South%20East%20Completed-2.png",
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67c1d2b874833dd5316b3ca8_South%20East%20Completed-2.png",
      ],
      SouthEastAreaB: [
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67c1d2b874833dd5316b3ca8_South%20East%20Completed-2.png",
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67c1d2b874833dd5316b3ca8_South%20East%20Completed-2.png",
      ],
      SouthWestAreaA: [
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67ce152c3c238822c45316cd_Southwest%20Map%20(2)-1.png",
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67ce152c530f75df6093d3d7_Southwest%20Map%20(2)-2.png",
      ],
      SouthWestAreaB: [
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67ce152c3c238822c45316cd_Southwest%20Map%20(2)-1.png",
        "https://cdn.prod.website-files.com/64d572ccd997a626d3de38d6/67ce152c530f75df6093d3d7_Southwest%20Map%20(2)-2.png",
      ],
    };

    // Helper function to format zone titles for display
    function formatZoneTitle(title) {
      return title
        .replace(/([A-Z])/g, " $1")
        .replace(/^./, (str) => str.toUpperCase())
        .trim();
    }

    // Store area coordinates for direct click detection
    const areaCoordinates = [];

    // Parse coordinates from area elements
    function parseCoordinates() {
      areaCoordinates.length = 0; // Clear existing coordinates
      allZones.length = 0; // Clear existing zones

      areas.forEach((area) => {
        const coords = area.getAttribute("coords").split(",").map(Number);
        const shape = area.getAttribute("shape");
        const title = area.getAttribute("title");

        // Create zone object for internal use
        if (zoneImageMap[title]) {
          const zone = {
            title: title,
            coords: coords,
            shape: shape,
            imagePaths: zoneImageMap[title],
            element: area,
          };
          allZones.push(zone);
        }

        if (shape === "poly") {
          // Create an array of points
          const points = [];
          for (let i = 0; i < coords.length; i += 2) {
            points.push({ x: coords[i], y: coords[i + 1] });
          }
          areaCoordinates.push({ shape, points, title });
        } else if (shape === "rect") {
          areaCoordinates.push({
            shape,
            points: [
              { x: coords[0], y: coords[1] }, // top-left
              { x: coords[2], y: coords[3] }, // bottom-right
            ],
            title,
          });
        } else if (shape === "circle") {
          areaCoordinates.push({
            shape,
            points: [
              { x: coords[0], y: coords[1] }, // center
              { radius: coords[2] }, // radius
            ],
            title,
          });
        }
      });

      console.log("Parsed coordinates:", areaCoordinates);
      console.log("Created zones:", allZones);

      // Create SVG highlights after parsing coordinates
      createAreaHighlights();
      setupMapAreaInteraction();
    }

    // Function to create SVG highlights for map areas
    function createAreaHighlights() {
      // Clear existing highlights
      if (highlightsContainer) {
        highlightsContainer.innerHTML = "";
      } else {
        console.warn("No highlights container found");
        return;
      }

      // Ensure map is loaded
      if (!mapImage || !mapImage.complete) {
        if (debugMode) {
          console.warn("Cannot create highlights: Map not loaded");
        }
        return;
      }

      // Get current map dimensions
      const mapWidth = mapImage.offsetWidth;
      const mapHeight = mapImage.offsetHeight;

      if (mapWidth === 0 || mapHeight === 0) {
        if (debugMode) {
          console.warn("Cannot create highlights: Map has zero dimensions");
        }
        return;
      }

      // Create SVG container for the highlights with explicit namespace
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute("class", "map-highlights");
      svg.setAttribute("width", mapWidth);
      svg.setAttribute("height", mapHeight);
      svg.setAttribute("viewBox", `0 0 ${mapWidth} ${mapHeight}`);
      svg.style.position = "absolute";
      svg.style.top = "0";
      svg.style.left = "0";
      svg.style.width = "100%";
      svg.style.height = "100%";
      svg.style.pointerEvents = "none"; // Make sure it doesn't interfere with clicks
      svg.style.zIndex = "3"; // Ensure it's above the map but below UI elements

      // Add the SVG to the container
      highlightsContainer.appendChild(svg);

      // Make sure the highlights container has the right positioning
      highlightsContainer.style.position = "absolute";
      highlightsContainer.style.top = "0";
      highlightsContainer.style.left = "0";
      highlightsContainer.style.width = "100%";
      highlightsContainer.style.height = "100%";
      highlightsContainer.style.pointerEvents = "none";
      highlightsContainer.style.zIndex = "3";

      if (debugMode) {
        console.log("Created SVG container for highlights:", {
          width: mapWidth,
          height: mapHeight,
          container: highlightsContainer,
        });
      }

      // Process each zone to create highlight polygons
      allZones.forEach((zone, index) => {
        if (zone.shape === "poly") {
          // Create polygon highlight with explicit namespace
          const polygon = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "polygon"
          );
          polygon.setAttribute("class", `zone-highlight zone-${index}`);
          polygon.setAttribute("data-zone", zone.title);

          // Set SVG styling attributes explicitly
          polygon.setAttribute("fill", "rgba(255, 0, 0, 0.2)");
          polygon.setAttribute("stroke", "#ff0000");
          polygon.setAttribute("stroke-width", "3");
          polygon.setAttribute("fill-opacity", "0");
          polygon.setAttribute("stroke-opacity", "0");

          // Add to SVG
          svg.appendChild(polygon);

          if (debugMode) {
            console.log("Created highlight for zone:", zone.title);
          }
        }
      });

      // Update polygon points based on current dimensions
      updateAreaHighlights();
    }

    // Update area highlights based on current dimensions
    function updateAreaHighlights() {
      if (!mapImage || !mapImage.complete) {
        if (debugMode) {
          console.warn("Cannot update highlights: Map not fully loaded");
        }
        return;
      }

      // Get current map dimensions
      const mapWidth = mapImage.offsetWidth;
      const mapHeight = mapImage.offsetHeight;

      // Get SVG viewBox dimensions (from the SVG file)
      const svgViewBoxWidth = 792; // From SVG viewBox attribute
      const svgViewBoxHeight = 1224; // From SVG viewBox attribute

      if (
        mapWidth === 0 ||
        mapHeight === 0 ||
        svgViewBoxWidth === 0 ||
        svgViewBoxHeight === 0
      ) {
        console.warn("Cannot update highlights: Invalid dimensions", {
          mapWidth,
          mapHeight,
          svgViewBoxWidth,
          svgViewBoxHeight,
        });
        return;
      }

      // Check for SVG and update its dimensions
      const svg = document.querySelector(".map-highlights");
      if (svg) {
        svg.setAttribute("width", mapWidth);
        svg.setAttribute("height", mapHeight);

        // Ensure SVG fills the container
        svg.style.width = "100%";
        svg.style.height = "100%";
        svg.style.position = "absolute";
        svg.style.top = "0";
        svg.style.left = "0";
      }

      // Calculate scale factors based on SVG viewBox
      const scaleX = mapWidth / svgViewBoxWidth;
      const scaleY = mapHeight / svgViewBoxHeight;

      if (debugMode) {
        console.log("Updating area highlights with scale factors:", {
          scaleX,
          scaleY,
          mapWidth,
          mapHeight,
          svgViewBoxWidth,
          svgViewBoxHeight,
        });
      }

      // Update each zone's polygon
      allZones.forEach((zone, index) => {
        if (zone.shape === "poly") {
          const polygon = document.querySelector(
            `.zone-highlight.zone-${index}`
          );
          if (!polygon) return;

          // Scale coordinates based on SVG viewBox
          const scaledPoints = [];
          for (let i = 0; i < zone.coords.length; i += 2) {
            const x = zone.coords[i] * scaleX;
            const y = zone.coords[i + 1] * scaleY;
            scaledPoints.push(`${x},${y}`);
          }

          // Update polygon points
          polygon.setAttribute("points", scaledPoints.join(" "));

          // Ensure all styling attributes are explicitly set
          polygon.setAttribute("fill", "rgba(255, 0, 0, 0.2)");
          polygon.setAttribute("stroke", "#ff0000");
          polygon.setAttribute("stroke-width", "3");
          polygon.setAttribute(
            "fill-opacity",
            polygon.classList.contains("active") ? "0.6" : "0"
          );
          polygon.setAttribute(
            "stroke-opacity",
            polygon.classList.contains("active") ? "1" : "0"
          );
        }
      });
    }

    // Set up hover interactions with map areas
    function setupMapAreaInteraction() {
      allZones.forEach((zone) => {
        zone.element.addEventListener("mouseenter", () => {
          if (!isMobile) {
            zoneLabel.textContent = formatZoneTitle(zone.title);
            zoneLabel.style.opacity = "1";
            highlightZone(zone.title);
          }
        });

        zone.element.addEventListener("mouseleave", () => {
          if (!isMobile) {
            zoneLabel.style.opacity = "0";
            clearHighlights();
          }
        });

        // For touch devices, we'll continue using the click/tap handling
      });
    }

    // Function to highlight a specific zone
    function highlightZone(title) {
      // Clear all highlights first
      clearHighlights();

      // Find the zone index
      const zoneIndex = allZones.findIndex((zone) => zone.title === title);
      if (zoneIndex === -1) return;

      // Highlight this zone
      const highlight = document.querySelector(
        `.zone-highlight.zone-${zoneIndex}`
      );
      if (highlight) {
        highlight.classList.add("active");
        // Set SVG attributes directly in addition to class
        highlight.setAttribute("fill-opacity", "0.6");
        highlight.setAttribute("stroke-opacity", "1");
      }
    }

    // Function to clear all highlights
    function clearHighlights() {
      document.querySelectorAll(".zone-highlight").forEach((highlight) => {
        highlight.classList.remove("active");
        // Reset SVG attributes
        highlight.setAttribute("fill-opacity", "0");
        highlight.setAttribute("stroke-opacity", "0");
      });
    }

    // Calculate scale ratio for the image
    function getImageScaleRatio() {
      // Get the original dimensions
      const naturalWidth = mapImage.naturalWidth;
      const naturalHeight = mapImage.naturalHeight;

      // Get current dimensions
      const currentWidth = mapImage.offsetWidth;
      const currentHeight = mapImage.offsetHeight;

      const scaleX = currentWidth / naturalWidth;
      const scaleY = currentHeight / naturalHeight;

      console.log(`Scale ratio: ${scaleX.toFixed(2)}x, ${scaleY.toFixed(2)}y`);

      return { scaleX, scaleY };
    }

    // Function to check if a point is inside a polygon
    function isPointInPoly(point, poly) {
      const { scaleX, scaleY } = getImageScaleRatio();
      let inside = false;

      // Scale the point according to the image scale
      const scaledPoint = {
        x: point.x / scaleX,
        y: point.y / scaleY,
      };

      // Ray casting algorithm
      for (let i = 0, j = poly.length - 1; i < poly.length; j = i++) {
        const xi = poly[i].x,
          yi = poly[i].y;
        const xj = poly[j].x,
          yj = poly[j].y;

        const intersect =
          yi > scaledPoint.y !== yj > scaledPoint.y &&
          scaledPoint.x < ((xj - xi) * (scaledPoint.y - yi)) / (yj - yi) + xi;

        if (intersect) inside = !inside;
      }

      return inside;
    }

    // Function to check if a point is in a circle
    function isPointInCircle(point, center, radius) {
      const { scaleX, scaleY } = getImageScaleRatio();

      // Scale the point and radius
      const scaledPoint = {
        x: point.x / scaleX,
        y: point.y / scaleY,
      };

      const scaledRadius = radius / Math.min(scaleX, scaleY);

      // Distance formula
      const distance = Math.sqrt(
        Math.pow(scaledPoint.x - center.x, 2) +
          Math.pow(scaledPoint.y - center.y, 2)
      );

      return distance <= scaledRadius;
    }

    // Function to check if a point is in a rectangle
    function isPointInRect(point, topLeft, bottomRight) {
      const { scaleX, scaleY } = getImageScaleRatio();

      // Scale the point
      const scaledPoint = {
        x: point.x / scaleX,
        y: point.y / scaleY,
      };

      return (
        scaledPoint.x >= topLeft.x &&
        scaledPoint.x <= bottomRight.x &&
        scaledPoint.y >= topLeft.y &&
        scaledPoint.y <= bottomRight.y
      );
    }

    // Initialize the coordinates on load
    parseCoordinates();

    // Call main initialization - this properly loads the map
    loadMapAndInitialize();

    // For browsers that might not trigger onload events correctly
    setTimeout(() => {
      if (!window.mapInitialized) {
        console.warn(
          "Map initialization may have failed, forcing initialization"
        );
        loadMapAndInitialize();
      }
    }, 1000);

    window.mapInitialized = true;
    console.log("Map initialization process started");

    // Add click event to each zone button
    const zoneButtons = document.querySelectorAll(".mobile-zone-button");
    zoneButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const zoneSlug = button.getAttribute("data-zone");
        selectZone(zoneSlug);

        // Update highlighted area
        updateActiveZoneHighlight(zoneSlug);

        if (debugMode) {
          console.log("Zone selected:", zoneSlug);
        }
      });
    });

    // Function to select a zone
    function selectZone(zoneSlug) {
      // Remove active class from all buttons
      zoneButtons.forEach((button) => {
        button.classList.remove("active");
      });

      // Add active class to selected button
      const selectedButton = document.querySelector(
        `.mobile-zone-button[data-zone="${zoneSlug}"]`
      );
      if (selectedButton) {
        selectedButton.classList.add("active");
      }

      // Update highlighted area
      updateActiveZoneHighlight(zoneSlug);

      // Additional UI updates
      const zoneTitle = document.querySelector(".zone-title");
      const zoneDescription = document.querySelector(".zone-description");
      const learnMoreLink = document.querySelector(".zone-learn-more a");

      // Update zone information
      if (zoneData[zoneSlug]) {
        zoneTitle.textContent = zoneData[zoneSlug].title;
        zoneDescription.textContent = zoneData[zoneSlug].description;
        if (learnMoreLink) {
          learnMoreLink.href = zoneData[zoneSlug].link;
        }
      }
    }

    // Function to update the active zone highlight
    function updateActiveZoneHighlight(zoneSlug) {
      // Remove active class from all highlights
      const highlights = document.querySelectorAll(".zone-highlight");
      highlights.forEach((highlight) => {
        highlight.classList.remove("active");
      });

      // Add active class to selected highlight
      const selectedHighlight = document.querySelector(
        `.zone-highlight[data-zone="${zoneSlug}"]`
      );
      if (selectedHighlight) {
        selectedHighlight.classList.add("active");

        if (debugMode) {
          console.log("Highlight activated for zone:", zoneSlug);
          console.log("Highlight element:", selectedHighlight);
          console.log("Highlight position:", {
            x: selectedHighlight.getBoundingClientRect().left,
            y: selectedHighlight.getBoundingClientRect().top,
            width: selectedHighlight.getBoundingClientRect().width,
            height: selectedHighlight.getBoundingClientRect().height,
          });
        }
      } else if (debugMode) {
        console.warn("No highlight found for zone:", zoneSlug);
      }
    }

    // Load the map and ensure it's completely loaded before initializing highlights
    if (mapImage) {
      // Check if map is already loaded
      if (mapImage.complete) {
        initializeMapHighlights();
        if (debugMode) {
          console.log(
            "Map was already loaded, highlights initialized immediately"
          );
        }
      } else {
        // Wait for map to load before initializing highlights
        mapImage.onload = function () {
          initializeMapHighlights();
          if (debugMode) {
            console.log("Map loaded, highlights initialized after load");
          }
        };

        // Error handling
        mapImage.onerror = function () {
          console.error("Error loading map image");
        };
      }
    } else {
      console.error("Map image element not found");
    }

    // Function to initialize map highlights
    function initializeMapHighlights() {
      createAreaHighlights();
      // Initialize with first zone by default, if any zones exist
      const firstZoneButton = document.querySelector(".zone-button");
      if (firstZoneButton) {
        const firstZoneSlug = firstZoneButton.getAttribute("data-zone");
        selectZone(firstZoneSlug);
      }
    }
  });
</script>
